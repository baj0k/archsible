---
- name: Localization settings
  block:
    - name: Enable NTP service
      command: timedatectl set-ntp true

    - name: Set timezone
      timezone:
        name: "{{ region }}/{{ city }}"
        hwclock: UTC

    - name: Remove unnecessary lines from locale.gen file
      lineinfile:
        path: /etc/locale.gen
        regexp: "#\\s+"
        state: absent

    - name: Generate locales
      locale_gen:
        name: "{{ item }}"
      loop:
        - en_US.UTF-8
        - "{{ country|lower + '_' + country + '.UTF-8' }}"

    - name: Create locale.conf
      lineinfile:
        create: yes
        path: /etc/locale.conf
        regexp: LANG=en_US\.UTF-8
        line: LANG=en_US.UTF-8
    
    - name: Create vconsole.conf
      blockinfile:
        create: yes
        path: /etc/vconsole.conf
        block: |
          KEYMAP={{ country|lower }}
          FONT=Lat2-Terminus16
          FONT_MAP=8859-2

    - name: Set a hostname
      hostname:
        name: "{{ hostname }}"

- name: User configuration
  block:
    - name: Create user
      user:
        name: "{{ user_username }}"
        groups:
          - adm
          - games
          - sys
          - wheel
          - lp
          - audio
          - kvm
          - video
        append: yes
        password: "{{ user_password | password_hash('sha512') }}"
        update_password: on_create

    - name: Give passwordless sudo access to the wheel group
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "%wheel ALL="
        line: "%wheel ALL=(ALL) NOPASSWD: ALL"
        validate: "/usr/sbin/visudo --check --file=%s"

- name: Blackarch configuration
  block:
    - name: Download blackarch setup script
      get_url:
        url: https://blackarch.org/strap.sh
        dest: /tmp/strap.sh
        
    - name: Setup blackarch repository
      command: "sh /tmp/strap.sh"

  when: blackarch

- name: Package management
  block:
    - name: Install reflector
      pacman:
        name:
          - reflector

    - name: Configure reflector
      lineinfile:
        path: /etc/xdg/reflector/reflector.conf
        regexp: "{{ item.regex }}"
        line: "{{ item.line }}"
      loop:
        - {regex: "^#*\\s*--country", line: "{{ '--country ' + country|lower + ',' }}" }
        - {regex: "^#*\\s*--protocol", line: "--protocol https" }
        - {regex: "^#*\\s*--sort", line: "--sort rate" }

    - name: Rank mirrors
      systemd:
        name: reflector
        state: started

    - name: Enabel multilib repository and change pacman configuration options
      lineinfile:
        dest: /etc/pacman.conf
        regexp: "{{ item.regex }}"
        line: "{{ item.line }}"
        insertafter: "{{ item.insertafter }}"
      loop:
        - {regex: Architecture, line: Architecture = x86_64, insertafter: }
        - {regex: Color, line: Color, insertafter: }
        - {regex: ILoveCandy, line: ILoveCandy, insertafter: Color}
        - {regex: ParallelDownloads, line: ParallelDownloads = 5, insertafter: }
        - {regex: NoExtract, line: NoExtract = mirrorlist.pacnew, insertafter: }
        - {regex: '^#\[multilib\]$', line: "[multilib]", insertafter: }
        - {regex: Include = /etc/pacman.d/mirrorlist, line: Include = /etc/pacman.d/mirrorlist, insertafter: "[multilib]" }

    - name: Update system
      pacman:
        update_cache: yes
        upgrade: yes
    
    - name: Install packages
      pacman:
        name:
          - wget
          - rsync
          - man-db
          - man-pages
          - base-devel
          - pkgfile
        state: present

    - name: Synchronize pkgfile database
      systemd:
        name: pkgfile-update
        state: started

- name: Audio configuration
  block:
    - name: Install audio related packages
      pacman:
        name: 
          - pipewire
          - lib32-pipewire
          - wireplumber
          - pipewire-alsa
          - pipewire-pulse
          - pipewire-jack
          - lib32-pipewire-jack
        state: present

    - name: Install bluetooth related packages
      pacman:
        name: 
          - bluez
          - bluez-utils
          - blueman
          - bluez-hid2hci
        state: present
    
    - name: Enable btusb module
      modprobe:
        name: btusb
        state: present
    
    - name: Enable bluetooth daemon
      systemd:
        name: bluetooth
        state: started
        enabled: yes

    - name: Auto power-on bluetooth on boot
      lineinfile:
        path: /etc/locale.conf
        regexp: AutoEnable=
        line: AutoEnable=true
  when: audio

- name: Systemd configuration
  block:
    - name: Enable service timer units
      systemd:
        name: "{{ item }}"
        enabled: yes
      loop:
        - reflector.timer
        - pkgfile-update.timer

- name: Import the hardening role
  include_tasks: hardening.yml
  when: hardening
